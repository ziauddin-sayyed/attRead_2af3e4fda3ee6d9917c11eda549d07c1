<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Tracking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .file-controls {
            margin-bottom: 20px;
            text-align: center;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        
        .filters {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e9ecef;
            border-radius: 5px;
            display: none;
        }
        
        .filters.visible {
            display: block;
        }
        
        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .filter-group label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #495057;
        }
        
        .file-input {
            margin: 5px;
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 200px;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            min-width: 120px;
        }
        
        .user-dropdown {
            position: relative;
            display: inline-block;
        }
        
        .user-dropdown-button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            min-width: 200px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-dropdown-button:hover {
            background-color: #f8f9fa;
        }
        
        .user-dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 100%;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 1px solid #ddd;
            border-radius: 5px;
            top: 100%;
            left: 0;
        }
        
        .user-dropdown-content.show {
            display: block;
        }
        
        .user-option {
            padding: 8px 12px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .user-option:hover {
            background-color: #f8f9fa;
        }
        
        .user-option input[type="checkbox"] {
            margin-right: 8px;
        }
        
        .select-all-option {
            border-bottom: 1px solid #ddd;
            font-weight: bold;
            background-color: #f8f9fa;
        }
        
        .load-btn, .filter-btn {
            background-color: #4CAF50;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .load-btn:hover, .filter-btn:hover {
            background-color: #45a049;
        }
        
        .load-btn:disabled, .filter-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .filter-btn {
            background-color: #2196F3;
        }
        
        .filter-btn:hover {
            background-color: #1976D2;
        }
        
        .clear-btn {
            background-color: #ff9800;
            color: white;
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        
        .clear-btn:hover {
            background-color: #f57c00;
        }
        
        .status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.loading {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
            display: none;
        }
        
        table.visible {
            display: table;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 12px;
        }
        
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .user-id {
            background-color: #f8f9fa;
            font-weight: bold;
            position: sticky;
            left: 0;
            z-index: 5;
        }
        
        .date-header {
            background-color: #2196F3;
            color: white;
        }
        
        .in-header {
            background-color: #4CAF50;
        }
        
        .out-header {
            background-color: #ff9800;
        }
        
        .in-time {
            background-color: #e8f5e8;
            color: #2e7d32;
        }
        
        .out-time {
            background-color: #fff3e0;
            color: #f57c00;
        }
        
        .empty-cell {
            background-color: #fafafa;
            color: #999;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f0f0f0;
        }
        
        .instructions {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-size: 14px;
        }
        
        .instructions h3 {
            margin-top: 0;
            color: #495057;
        }
        
        .instructions code {
            background-color: #e9ecef;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: monospace;
        }
        
        .sample-format {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        .filter-summary {
            margin: 10px 0;
            padding: 8px;
            background-color: #e3f2fd;
            border-radius: 5px;
            font-size: 14px;
            color: #1565c0;
            text-align: center;
        }
        .short-duration {
            background-color: #f8d7da !important;
            color: #721c24;
            font-weight: bold;
        }

    </style>
</head>
<script>

var users = {
  "401": {"name": "Shamran"},
  "404": {"name": "Khalid"},
  "405": {"name": "Tanveer"},
  "319": {"name": "Naved"},
  "311": {"name": "Mohammedaadil"},
  "310": {"name": "Mohdtanzeem"},
  "309": {"name": "Khalilullah"},
  "316": {"name": "Mujeeb"},
  "306": {"name": "Shahnawaz"},
  "312": {"name": "Shakeel"},
  "328": {"name": "Wasif"},
  "314": {"name": "Mujahid"},
  "327": {"name": "lateef"},
  "326": {"name": "Shafi"},
  "317": {"name": "Iqbal"},
  "504": {"name": "Faizan"},
  "318": {"name": "Mehjabeen"},
  "5": {"name": "Irfan"},
  "320": {"name": "Shakirkhan"},
  "315": {"name": "Javed"},
  "410": {"name": "Navin"},
  "313": {"name": "Abdulgaffar"},
  "307": {"name": "Nadeem"},
  "308": {"name": "Ayyubkhan"},
  "402": {"name": "Masum"},
  "406": {"name": "Imran"},
  "407": {"name": "Jagat"},
  "510": {"name": "NN-510"},
  "512": {"name": "Salim"},
  "511": {"name": "Adiba"},
  "408": {"name": "Prasand"},
  "207": {"name": "Shahalam"},
  "206": {"name": "Izhaar"},
  "204": {"name": "Anwarulhaque"},
  "205": {"name": "Jamil"},
  "506": {"name": "Nadeem"},
  "507": {"name": "Zakir"},
  "508": {"name": "Awais"},
  "503": {"name": "Khansa"},
  "106": {"name": "Jasmin"},
  "514": {"name": "Ashfaque"},
  "101": {"name": "Fauzia"},
  "210": {"name": "Rizwana"},
  "208": {"name": "Athar"},
  "209": {"name": "Saqib"},
  "213": {"name": "Jahida"},
  "214": {"name": "Saeedunnisa"},
  "211": {"name": "Kayas"},
  "102": {"name": "Mujahid", "card": "1967"},
  "212": {"name": "Atiq"},
  "103": {"name": "Altaf"},
  "220": {"name": "Varsha"},
  "516": {"name": "Raaes"},
  "215": {"name": "Akbar"},
  "216": {"name": "Ayman"},
  "1": {"name": "NN-1"}
}



</script>

<body>
    <div class="container">
        <h1>Employee Attendance Tracking</h1>
        
        <!-- <div class="instructions">
            <h3>Setup Instructions:</h3>
            <ol>
                <li>Place your CSV file in the same directory as this HTML file</li>
                <li>Enter the filename in the input below (e.g., <code>attendance.csv</code>)</li>
                <li>Serve this directory using a local web server:
                    <ul>
                        <li><strong>Python:</strong> <code>python -m http.server 8000</code></li>
                        <li><strong>Node.js:</strong> <code>npx http-server</code></li>
                        <li><strong>PHP:</strong> <code>php -S localhost:8000</code></li>
                    </ul>
                </li>
                <li>Open <code>http://localhost:8000</code> in your browser</li>
            </ol>
        </div> -->
        
        <div class="file-controls">
            <input type="text" id="filename" class="file-input" placeholder="Enter CSV filename (e.g., attendance.csv)" value="attendance.csv" />
            <button onclick="loadLocalCSV()" class="load-btn" id="loadBtn">Load Data</button>
        </div>
        
        <div id="filters" class="filters">
            <h3 style="margin-top: 0; text-align: center; color: #495057;">Filter Options</h3>
            <div class="filter-row">
                <div class="filter-group">
                    <label for="yearFilter">Year:</label>
                    <select id="yearFilter" class="filter-select">
                        <option value="">All Years</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="monthFilter">Month:</label>
                    <select id="monthFilter" class="filter-select">
                        <option value="">All Months</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>Users:</label>
                    <div class="user-dropdown">
                        <div class="user-dropdown-button" onclick="toggleUserDropdown()">
                            <span id="userDropdownText">Select Users</span>
                            <span>▼</span>
                        </div>
                        <div id="userDropdownContent" class="user-dropdown-content">
                            <div class="user-option select-all-option">
                                <input type="checkbox" id="selectAllUsers" onchange="toggleAllUsers()">
                                <label for="selectAllUsers">Select All</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="filter-row">
                <button onclick="applyFilters()" class="filter-btn">Apply Filters</button>
                <button onclick="clearFilters()" class="clear-btn">Clear Filters</button>
            </div>
            
            <div id="filterSummary" class="filter-summary" style="display: none;"></div>
        </div>
        
        <div id="status" class="status info">
            Enter the CSV filename and click "Load CSV File" to display attendance data.
        </div>
        
        <!-- <div class="sample-format">
            <h3>Expected CSV Format (attendance.csv):</h3>
            UserID,Timestamp<br>
            401,2024-02-29 14:20:22<br>
            507,2024-02-29 14:34:04<br>
            405,2024-02-29 14:35:13<br>
            408,2024-02-29 14:41:13<br>
            ...
        </div> -->
        
        <table id="attendanceTable">
            <thead>
                <tr id="headerRow">
                    <th rowspan="2" class="user-id">User ID</th>
                </tr>
                <tr id="subHeaderRow">
                </tr>
            </thead>
            <tbody id="tableBody">
            </tbody>
        </table>
    </div>

    <!-- Include Papa Parse library for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <script>
        let attendanceData = [];
        let originalData = [];
        let allUsers = [];

        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function setLoadingState(loading) {
            const loadBtn = document.getElementById('loadBtn');
            const filenameInput = document.getElementById('filename');
            
            loadBtn.disabled = loading;
            filenameInput.disabled = loading;
            loadBtn.textContent = loading ? 'Loading...' : 'Load CSV File';
        }

        function initializeYearDropdown() {
            const yearSelect = document.getElementById('yearFilter');
            yearSelect.innerHTML = '<option value="">All Years</option>';
            
            for (let year = 2024; year <= 2033; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            }
        }

        function populateUserDropdown() {
            const userDropdownContent = document.getElementById('userDropdownContent');
            
            // Clear existing user options (keep select all)
            const selectAllOption = userDropdownContent.querySelector('.select-all-option');
            userDropdownContent.innerHTML = '';
            userDropdownContent.appendChild(selectAllOption);
            
            // Get unique users and sort them
            allUsers = [...new Set(originalData.map(record => record.userId))].sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a.localeCompare(b);
            });
            
            // Add user options
            allUsers.forEach(userId => {
                const userOption = document.createElement('div');
                userOption.className = 'user-option';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `user_${userId}`;
                checkbox.value = userId;
                checkbox.checked = true;
                checkbox.onchange = updateUserDropdownText;
                
                const label = document.createElement('label');
                label.htmlFor = `user_${userId}`;
                // label.textContent = `User ${userId}`;
                label.textContent = users[userId].name +"-"+ userId;
                
                userOption.appendChild(checkbox);
                userOption.appendChild(label);
                userDropdownContent.appendChild(userOption);
            });
            
            updateUserDropdownText();
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdownContent');
            dropdown.classList.toggle('show');
        }

        function toggleAllUsers() {
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const userCheckboxes = document.querySelectorAll('#userDropdownContent input[type="checkbox"]:not(#selectAllUsers)');
            
            userCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            updateUserDropdownText();
        }

        function updateUserDropdownText() {
            const userCheckboxes = document.querySelectorAll('#userDropdownContent input[type="checkbox"]:not(#selectAllUsers)');
            const checkedBoxes = Array.from(userCheckboxes).filter(cb => cb.checked);
            const selectAllCheckbox = document.getElementById('selectAllUsers');
            const dropdownText = document.getElementById('userDropdownText');
            
            if (checkedBoxes.length === 0) {
                dropdownText.textContent = 'No users selected';
                selectAllCheckbox.checked = false;
            } else if (checkedBoxes.length === userCheckboxes.length) {
                dropdownText.textContent = 'All users selected';
                selectAllCheckbox.checked = true;
            } else {
                dropdownText.textContent = `${checkedBoxes.length} users selected`;
                selectAllCheckbox.checked = false;
            }
        }

        function applyFilters() {
            const yearFilter = document.getElementById('yearFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const selectedUsers = Array.from(document.querySelectorAll('#userDropdownContent input[type="checkbox"]:not(#selectAllUsers):checked'))
                .map(cb => cb.value);
            
            if (selectedUsers.length === 0) {
                showStatus('Please select at least one user.', 'error');
                return;
            }
            
            // Filter the data
            attendanceData = originalData.filter(record => {
                const date = record.timestamp.split(' ')[0];
                const [recordYear, recordMonth] = date.split('-');
                
                // Apply year filter
                if (yearFilter && recordYear !== yearFilter) {
                    return false;
                }
                
                // Apply month filter
                if (monthFilter && recordMonth !== monthFilter) {
                    return false;
                }
                
                // Apply user filter
                if (!selectedUsers.includes(record.userId)) {
                    return false;
                }
                
                return true;
            });
            
            // Update filter summary
            updateFilterSummary(yearFilter, monthFilter, selectedUsers);
            
            if (attendanceData.length === 0) {
                showStatus('No records found for the selected filters.', 'error');
                document.getElementById('attendanceTable').classList.remove('visible');
                return;
            }
            
            showStatus(`Showing ${attendanceData.length} filtered records.`, 'success');
            createTable();
        }

        function clearFilters() {
            // Reset all filters
            document.getElementById('yearFilter').value = '';
            document.getElementById('monthFilter').value = '';
            
            // Select all users
            const userCheckboxes = document.querySelectorAll('#userDropdownContent input[type="checkbox"]');
            userCheckboxes.forEach(cb => cb.checked = true);
            updateUserDropdownText();
            
            // Reset data
            attendanceData = [...originalData];
            
            // Hide filter summary
            document.getElementById('filterSummary').style.display = 'none';
            
            showStatus(`Showing all ${attendanceData.length} records.`, 'success');
            createTable();
        }

        function updateFilterSummary(year, month, users) {
            const summary = document.getElementById('filterSummary');
            let summaryText = 'Filters applied: ';
            const filters = [];
            
            if (year) filters.push(`Year: ${year}`);
            if (month) {
                const monthNames = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                                 'July', 'August', 'September', 'October', 'November', 'December'];
                filters.push(`Month: ${monthNames[parseInt(month)]}`);
            }
            if (users.length < allUsers.length) {
                filters.push(`Users: ${users.length} selected`);
            }
            
            if (filters.length === 0) {
                summary.style.display = 'none';
            } else {
                summaryText += filters.join(', ');
                summary.textContent = summaryText;
                summary.style.display = 'block';
            }
        }

        async function loadLocalCSV() {
            const filename = document.getElementById('filename').value.trim();
            
            if (!filename) {
                showStatus('Please enter a CSV filename.', 'error');
                return;
            }
            
            setLoadingState(true);
            showStatus('Loading CSV file...', 'loading');
            
            try {
                const response = await fetch(filename);
                
                if (!response.ok) {
                    throw new Error(`Failed to load file: ${response.status} ${response.statusText}`);
                }
                
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false,
                    complete: function(results) {
                        setLoadingState(false);
                        
                        if (results.errors.length > 0) {
                            showStatus('Error parsing CSV: ' + results.errors[0].message, 'error');
                            return;
                        }
                        
                        if (results.data.length === 0) {
                            showStatus('CSV file is empty.', 'error');
                            return;
                        }
                        
                        const headers = Object.keys(results.data[0]);
                        const requiredHeaders = ['UserID', 'Timestamp'];
                        const hasRequiredHeaders = requiredHeaders.every(header => 
                            headers.some(h => h.trim().toLowerCase() === header.toLowerCase())
                        );
                        
                        if (!hasRequiredHeaders) {
                            showStatus(`CSV must contain UserID and Timestamp columns. Found: ${headers.join(', ')}`, 'error');
                            return;
                        }
                        
                        const userIdKey = headers.find(h => h.trim().toLowerCase() === 'userid');
                        const timestampKey = headers.find(h => h.trim().toLowerCase() === 'timestamp');
                        
                        originalData = results.data.map(row => ({
                            userId: row[userIdKey]?.toString().trim(),
                            timestamp: row[timestampKey]?.toString().trim()
                        })).filter(row => row.userId && row.timestamp);
                        
                        if (originalData.length === 0) {
                            showStatus('No valid attendance records found in CSV.', 'error');
                            return;
                        }
                        
                        attendanceData = [...originalData];
                        
                        // Show filters and populate dropdowns
                        document.getElementById('filters').classList.add('visible');
                        populateUserDropdown();
                        
                        showStatus(`Successfully loaded ${originalData.length} attendance records from ${filename}.`, 'success');
                        createTable();
                    },
                    error: function(error) {
                        setLoadingState(false);
                        showStatus('Error parsing CSV: ' + error.message, 'error');
                    }
                });
                
            } catch (error) {
                setLoadingState(false);
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus(`File "${filename}" not found. Make sure the file exists in the same directory and you're using a web server.`, 'error');
                } else {
                    showStatus('Error loading file: ' + error.message, 'error');
                }
            }
        }

        function processAttendanceData() {
            const userDateMap = {};
            const dates = new Set();
            const users = new Set();

            attendanceData.forEach(record => {
                let dateTime = record.timestamp.trim();
                let date, time;
                
                if (dateTime.includes(' ')) {
                    [date, time] = dateTime.split(' ');
                } else if (dateTime.includes('T')) {
                    [date, time] = dateTime.split('T');
                    time = time.split('.')[0];
                } else {
                    date = dateTime;
                    time = '00:00:00';
                }
                
                dates.add(date);
                users.add(record.userId);
                
                if (!userDateMap[record.userId]) {
                    userDateMap[record.userId] = {};
                }
                
                if (!userDateMap[record.userId][date]) {
                    userDateMap[record.userId][date] = [];
                }
                
                userDateMap[record.userId][date].push(time);
            });

            const sortedDates = Array.from(dates).sort();
            const sortedUsers = Array.from(users).sort((a, b) => {
                const numA = parseInt(a);
                const numB = parseInt(b);
                if (!isNaN(numA) && !isNaN(numB)) {
                    return numA - numB;
                }
                return a.localeCompare(b);
            });

            return { userDateMap, sortedDates, sortedUsers };
        }

function createTable() {
    const { userDateMap, sortedDates, sortedUsers } = processAttendanceData();

    const headerRow = document.getElementById('headerRow');
    const subHeaderRow = document.getElementById('subHeaderRow');
    const tableBody = document.getElementById('tableBody');

    // Clear existing table headers and body
    while (headerRow.children.length > 1) {
        headerRow.removeChild(headerRow.lastChild);
    }
    subHeaderRow.innerHTML = '';
    tableBody.innerHTML = '';

    // Step 1: Compute working days (≥ 4 users present)
    const workingDays = sortedDates.filter(date => {
        let count = 0;
        sortedUsers.forEach(userId => {
            if (userDateMap[userId]?.[date]) {
                count++;
            }
        });
        return count >= 4;
    });

    // Add "Days Served" column header
    const daysServedTh = document.createElement('th');
    daysServedTh.rowSpan = 2;
    daysServedTh.textContent = 'Days Served (Present / Total)';
    daysServedTh.style.backgroundColor = '#03a9f4';
    daysServedTh.style.color = 'white';
    headerRow.appendChild(daysServedTh);

    // Create headers for each date (In, Out, Duration)
    sortedDates.forEach(date => {
        const th = document.createElement('th');
        th.colSpan = 3;
        th.className = 'date-header';
        th.textContent = date;
        headerRow.appendChild(th);

        const inTh = document.createElement('th');
        inTh.className = 'in-header';
        inTh.textContent = 'In';
        subHeaderRow.appendChild(inTh);

        const outTh = document.createElement('th');
        outTh.className = 'out-header';
        outTh.textContent = 'Out';
        subHeaderRow.appendChild(outTh);

        const durationTh = document.createElement('th');
        durationTh.className = 'duration-header';
        durationTh.textContent = 'Duration';
        subHeaderRow.appendChild(durationTh);
    });

    // Create table rows for each user
    sortedUsers.forEach(userId => {
        const row = document.createElement('tr');

        // User ID cell
        const userCell = document.createElement('td');
        userCell.className = 'user-id';
        // userCell.textContent = userId;
        userCell.textContent = users[userId].name+" - "+userId ;
        row.appendChild(userCell);

        // Calculate present days
        let presentDays = 0;
        workingDays.forEach(date => {
            if (userDateMap[userId]?.[date]?.length) {
                presentDays++;
            }
        });

        // Add Days Served cell
        const servedCell = document.createElement('td');
        servedCell.textContent = `${presentDays} / ${workingDays.length}`;
        servedCell.style.backgroundColor = '#e1f5fe';
        servedCell.style.textAlign = 'center';
        servedCell.style.fontWeight = 'bold';
        row.appendChild(servedCell);

        // Add per-date attendance (In, Out, Duration)
        sortedDates.forEach(date => {
            const userTimes = userDateMap[userId] && userDateMap[userId][date]
                ? userDateMap[userId][date].sort()
                : [];

            let inTime = '-';
            let outTime = '-';
            let duration = '-';
            let totalMinutes = 0;

            if (userTimes.length > 0) {
                const [h, m] = userTimes[0].split(':');
                inTime = `${h}:${m}`;
            }

            if (userTimes.length > 1) {
                const [h1, m1] = userTimes[0].split(':').map(Number);
                const [h2, m2] = userTimes[userTimes.length - 1].split(':').map(Number);
                outTime = `${h2.toString().padStart(2, '0')}:${m2.toString().padStart(2, '0')}`;

                totalMinutes = (h2 * 60 + m2) - (h1 * 60 + m1);
                if (totalMinutes < 0) totalMinutes = 0;

                const hours = Math.floor(totalMinutes / 60);
                const mins = totalMinutes % 60;
                duration = `${hours}h ${mins}m`;
            }

            const inCell = document.createElement('td');
            inCell.textContent = inTime;
            inCell.className = inTime !== '-' ? 'in-time' : 'empty-cell';
            row.appendChild(inCell);

            const outCell = document.createElement('td');
            outCell.textContent = outTime;
            outCell.className = outTime !== '-' ? 'out-time' : 'empty-cell';
            row.appendChild(outCell);

            const durationCell = document.createElement('td');
            durationCell.textContent = duration;
            if (duration !== '-') {
                durationCell.className = 'duration-time';
                if (totalMinutes < 480) {
                    durationCell.classList.add('short-duration');
                }
            } else {
                durationCell.className = 'empty-cell';
            }
            row.appendChild(durationCell);
        });

        tableBody.appendChild(row);
    });

    document.getElementById('attendanceTable').classList.add('visible');
}



        // Initialize and event handlers
        document.addEventListener('DOMContentLoaded', function() {
            initializeYearDropdown();
            
            const filenameInput = document.getElementById('filename');
            filenameInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadLocalCSV();
                }
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.user-dropdown')) {
                    document.getElementById('userDropdownContent').classList.remove('show');
                }
            });
        });
    </script>
</body>
</html>
